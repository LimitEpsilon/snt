\usepackage{geometry}
\geometry{
  a4paper,
  total={170mm,257mm},
  left=20mm,
  top=20mm,
}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{kotex}
\usepackage{csquotes}
\usepackage{tabularray}
\usepackage{relsize}

%%% Typesetting for listings
\usepackage{listings}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{ltblue}{rgb}{0,0.4,0.4}
\definecolor{dkviolet}{rgb}{0.3,0,0.5}

%%% lstlisting coq style (inspired from a file of Assia Mahboubi)
\lstdefinelanguage{Coq}{ 
    % Anything betweeen $ becomes LaTeX math mode
    mathescape=true,
    % Comments may or not include Latex commands
    texcl=false, 
    % Vernacular commands
    morekeywords=[1]{Section, Module, End, Require, Import, Export,
        Variable, Variables, Parameter, Parameters, Axiom, Hypothesis,
        Hypotheses, Notation, Local, Tactic, Reserved, Scope, Open, Close,
        Bind, Delimit, Definition, Let, Ltac, Fixpoint, CoFixpoint, Add,
        Morphism, Relation, Implicit, Arguments, Unset, Contextual,
        Strict, Prenex, Implicits, Inductive, CoInductive, Record,
        Structure, Canonical, Coercion, Context, Class, Global, Instance,
        Program, Infix, Theorem, Lemma, Corollary, Proposition, Fact,
        Remark, Example, Proof, Goal, Save, Qed, Defined, Hint, Resolve,
        Rewrite, View, Search, Show, Print, Printing, All, Eval, Check,
        Projections, inside, outside, Def},
    % Gallina
    morekeywords=[2]{forall, exists, exists2, fun, fix, cofix, struct,
        match, with, end, as, in, return, let, if, is, then, else, for, of,
        nosimpl, when},
    % Sorts
    morekeywords=[3]{Type, Prop, Set, true, false, option},
    % Various tactics, some are std Coq subsumed by ssr, for the manual purpose
    morekeywords=[4]{pose, set, move, case, elim, apply, clear, hnf,
        intro, intros, generalize, rename, pattern, after, destruct,
        induction, using, refine, inversion, injection, rewrite, congr,
        unlock, compute, ring, field, fourier, replace, fold, unfold,
        change, cutrewrite, simpl, have, suff, wlog, suffices, without,
        loss, nat_norm, assert, cut, trivial, revert, bool_congr, nat_congr,
        symmetry, transitivity, auto, split, left, right, autorewrite},
    % Terminators
    morekeywords=[5]{by, done, exact, reflexivity, tauto, romega, omega,
        assumption, solve, contradiction, discriminate},
    % Control
    morekeywords=[6]{do, last, first, try, idtac, repeat},
    % Comments delimiters, we do turn this off for the manual
    morecomment=[s]{(*}{*)},
    % Spaces are not displayed as a special character
    showstringspaces=false,
    % String delimiters
    morestring=[b]",
    morestring=[d],
    % Size of tabulations
    tabsize=3,
    % Enables ASCII chars 128 to 255
    extendedchars=false,
    % Case sensitivity
    sensitive=true,
    % Automatic breaking of long lines
    breaklines=false,
    % Default style fors listings
    basicstyle=\small,
    % Position of captions is bottom
    captionpos=b,
    % flexible columns
    columns=[l]flexible,
    % Style for (listings') identifiers
    identifierstyle={\ttfamily\color{black}},
    % Style for declaration keywords
    keywordstyle=[1]{\ttfamily\color{dkviolet}},
    % Style for gallina keywords
    keywordstyle=[2]{\ttfamily\color{dkgreen}},
    % Style for sorts keywords
    keywordstyle=[3]{\ttfamily\color{ltblue}},
    % Style for tactics keywords
    keywordstyle=[4]{\ttfamily\color{dkblue}},
    % Style for terminators keywords
    keywordstyle=[5]{\ttfamily\color{dkred}},
    %Style for iterators
    %keywordstyle=[6]{\ttfamily\color{dkpink}},
    % Style for strings
    stringstyle=\ttfamily,
    % Style for comments
    commentstyle={\ttfamily\color{dkgreen}},
    %moredelim=**[is][\ttfamily\color{red}]{/&}{&/},
    literate=
    {\\forall}{{\color{dkgreen}{$\forall\;$}}}1
    {\\exists}{{$\exists\;$}}1
    {\ge -}{{$\geftarrow\;$}}1
    {=>}{{$\Rightarrow\;$}}1
    {==}{{\code{==}\;}}1
    {==>}{{\code{==>}\;}}1
    %    {:>}{{\code{:>}\;}}1
    {->}{{$\rightarrow\;$}}1
    {\ge ->}{{$\geftrightarrow\;$}}1
    {\ge ==}{{$\geq\;$}}1
    {\#}{{$^\star$}}1 
    {\\o}{{$\circ\;$}}1 
    {\@}{{$\cdot$}}1 
    {\/\\}{{$\text{ and }\;$}}1
    {\\\/}{{$\vee\;$}}1
    {++}{{\code{++}}}1
    {~}{{\ }}1
    {\@\@}{{$@$}}1
    {\\mapsto}{{$\mapsto\;$}}1
    {\\hline}{{\rule{\linewidth}{0.5pt}}}1
    %
}[keywords,comments,strings]

%%% Math settings
\usepackage{amssymb,amsmath,amsthm,mathtools}
\usepackage[math-style=TeX,bold-style=TeX]{unicode-math}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{example}{Example}[section]
\newtheorem{lem}{Lemma}[section]
\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}{Corollary}[section]
\newtheorem{clm}{Claim}[section]

%%% Font settings
%\setmainfont{Libertinus Serif}
%\setsansfont{Libertinus Sans}[Scale=MatchUppercase]
%\setmonofont{JuliaMono}[Scale=MatchLowercase]
%\setmainhangulfont{Noto Serif CJK KR}
%\setmonohangulfont{D2Coding}

%%% PL constructs
\usepackage{galois}
\usepackage{ebproof}
%% InfRule command
\ExplSyntaxOn
\NewTblrEnviron{@ruleenv}
\SetTblrInner[@ruleenv]{belowsep=0pt,stretch=0}
\SetTblrOuter[@ruleenv]{baseline=b}
\NewDocumentEnvironment { InfRule } { m +b }
  {
    \begin{@ruleenv}{l}
      \smaller{\textsc{#1}} \\
      \begin{prooftree} #2 \end{prooftree}
    \end{@ruleenv}
  }
  {}
\ExplSyntaxOff

%% Modification for \infer
\ExplSyntaxOn
\int_new:N \g__ebproof_sublevel_int
\box_new:N \g__ebproof_substack_box
\seq_new:N \g__ebproof_substack_seq

\cs_new:Nn \__ebproof_clear_substack:
  {
    \int_gset:Nn \g__ebproof_sublevel_int { 0 }
    \hbox_gset:Nn \g__ebproof_substack_box { }
    \seq_gclear:N \g__ebproof_substack_seq
  }

\cs_new:Nn \__ebproof_subpush:N
  {
    \int_gincr:N \g__ebproof_sublevel_int
    \hbox_gset:Nn \g__ebproof_substack_box
      { \hbox_unpack:N \g__ebproof_substack_box \box_use:c { \__ebproof_box:N #1 } }
    \seq_gput_left:Nv \g__ebproof_substack_seq
      { \__ebproof_marks:N #1 }
  }

\cs_new:Nn \__ebproof_subpop:N
  {
    \int_compare:nNnTF { \g__ebproof_sublevel_int } > { 0 }
      {
        \int_gdecr:N \g__ebproof_sublevel_int
        \hbox_gset:Nn \g__ebproof_substack_box {
          \hbox_unpack:N \g__ebproof_substack_box
          \box_gset_to_last:N \g_tmpa_box
        }
        \box_set_eq_drop:cN { \__ebproof_box:N #1 } \g_tmpa_box
        \seq_gpop_left:NN \g__ebproof_substack_seq \l_tmpa_tl
        \tl_set_eq:cN { \__ebproof_marks:N #1 } \l_tmpa_tl
      }
      { \PackageError{ebproof}{Missing~premiss~in~a~proof~tree}{} \__ebproof_clear:N #1 }
  }

\cs_new:Nn \__ebproof_append_subvertical:NN
  {
    \bool_if:NTF \l__ebproof_updown_bool
      { \__ebproof_append_above:NN #1 #2 }
      { \__ebproof_append_below:NN #1 #2 }
  }

\cs_new:Nn \__ebproof_join_subvertical:n
  {
    \group_begin:
    \__ebproof_subpop:N \l__ebproof_a_box
    \prg_replicate:nn { #1 - 1 }
      {
        \__ebproof_subpop:N \l__ebproof_b_box
        \__ebproof_enlarge_conclusion:NN \l__ebproof_b_box \l__ebproof_a_box

        \__ebproof_make_vertical:Nnnn \l__ebproof_c_box
          { \__ebproof_mark:Nn \l__ebproof_b_box {axis} - \__ebproof_mark:Nn \l__ebproof_b_box {left} }
          { \__ebproof_mark:Nn \l__ebproof_b_box {right} - \__ebproof_mark:Nn \l__ebproof_b_box {left} }
          { \skip_vertical:N \l__ebproof_rule_margin_dim }
        \__ebproof_vcenter:N \l__ebproof_b_box
        \__ebproof_append_subvertical:NN \l__ebproof_a_box \l__ebproof_c_box

        \__ebproof_append_subvertical:NN \l__ebproof_a_box \l__ebproof_b_box
      }
    \__ebproof_push:N \l__ebproof_a_box
    \group_end:
  }

\cs_new:Nn \__ebproof_renew_statement:nnn
  {
    \exp_args:Nc \RenewDocumentCommand { ebproof#1 }{ #2 } { #3 }
    \seq_gput_right:Nn \g__ebproof_statements_seq { #1 }
  }
\__ebproof_renew_statement:nnn { infer } { O{} m O{} m }
  {
    \group_begin:
    \__ebproof_restore_statements:
    \keys_set_known:nnN { ebproof / rule~style } { #1 } \l_tmpa_tl
    \keys_set:nV { ebproof } \l_tmpa_tl
    \tl_set:Nn \l__ebproof_right_label_tl { #3 }

    \__ebproof_clear_substack:
    \clist_map_inline:nn { #2 }
      {
        \__ebproof_join_horizontal:n { ##1 }
        \__ebproof_pop:N \l__ebproof_a_box
        \__ebproof_subpush:N \l__ebproof_a_box
      }
    \__ebproof_join_subvertical:n { \clist_count:n { #2 } }

    \__ebproof_push_statement:n { #4 }
    \__ebproof_join_vertical:
    \group_end:
  }
\ExplSyntaxOff
\ebproofset{left label template=\textsc{[\inserttext]}}
\ebproofset{center=false}

%%% Custom commands
\newcommand*{\vbar}{|}
\newcommand*{\finto}{\xrightarrow{\text{\textrm{fin}}}}
\newcommand*{\istype}{\mathrel{â©´}}
\newcommand*{\ortype}{\mathrel{|}}
\newcommand*{\cons}{::}
\newcommand*{\pset}{\mathscr{P}}
\newcommand*{\closeloc}[2]{\prescript{\text{\textbackslash}{#1}}{}{#2}}
\newcommand*{\openloc}[2]{{#1}^{#2}}

\def\ovbarw{1.2mu}
\def\ovbarh{1}
\newcommand*{\ovbar}[1]{\mkern \ovbarw\overline{\mkern-\ovbarw{\smash{#1}\scalebox{1}[\ovbarh]{\vphantom{i}}}\mkern-\ovbarw}\mkern \ovbarw}
\newcommand*{\A}[1]{\overset{\,_{\mbox{\Large .}}}{#1}}
\newcommand*{\Abs}[1]{{#1}^{\#}}
\newcommand*{\Expr}{\text{Expr}}
\newcommand*{\ExprVar}{\text{Var}}
\newcommand*{\Module}{\text{Module}}
\newcommand*{\ModVar}{\text{ModVar}}
\newcommand*{\modid}{d}
\newcommand*{\Time}{\mathbb{T}}
\newcommand*{\ATime}{\A{\Time}}
\newcommand*{\Ctx}{\text{Env}}
\newcommand*{\ctx}{\sigma}
\newcommand*{\Value}{\text{Val}}
\newcommand*{\Walue}{\text{WVal}}
\newcommand*{\Mem}{\text{Heap}}
\newcommand*{\Loc}{\text{Loc}}
\newcommand*{\FLoc}{\text{FLoc}}
\newcommand*{\Left}{\text{Left}}
\newcommand*{\Right}{\text{Right}}
\newcommand*{\Sig}{\text{Sig}}
\newcommand*{\mem}{H}
\newcommand*{\dom}{\text{dom}}
\newcommand*{\AMem}{\A{\text{Heap}}}
\newcommand*{\State}{\text{State}}
\newcommand*{\AState}{\A{\text{State}}}
\newcommand*{\Result}{\text{Result}}
\newcommand*{\AResult}{\A{\text{Result}}}
\newcommand*{\Tick}{\text{Tick}}
\newcommand*{\lfp}{\mathsf{lfp}}
\newcommand*{\Step}{\mathsf{Step}}
\newcommand*{\semarrow}{\Downarrow}
\newcommand*{\asemarrow}{\A{\rightsquigarrow}}
\newcommand*{\synlink}{\rtimes}
\newcommand*{\semlink}{\mathbin{\rotatebox[origin=c]{180}{$\propto$}}}
\newcommand*{\link}[2]{{#1}\rtimes{#2}}
\newcommand*{\mt}{\mathsf{empty}}
\newcommand*{\valid}{\mathsf{valid}}
\newcommand*{\Path}{\text{Path}}
\newcommand*{\equivalent}{\sim}
\newcommand*{\tystate}{t}

\newcommand*{\doubleplus}{\ensuremath{\mathbin{+\mkern-3mu+}}}
\newcommand*{\project}{\text{\texttt{:>} }}
\newcommand*{\Exp}{\mathsf{Exp}}
\newcommand*{\Imp}{\mathsf{Imp}}
\newcommand*{\Fin}{\mathsf{Fin}}
\newcommand*{\Link}{\mathsf{Link}}
\newcommand*{\sembracket}[1]{\lBrack{#1}\rBrack}
\newcommand*{\fin}[2]{{#1}\xrightarrow{\text{fin}}{#2}}
\newcommand*{\addr}{\mathsf{addr}}
\newcommand*{\tick}{\mathsf{tick}}
\newcommand*{\modctx}{\mathsf{ctx}}
\newcommand*{\mapinject}[2]{{#2}[{#1}]}
\newcommand*{\inject}[2]{{#2}\langle{#1}\rangle}
\newcommand*{\deletepre}[2]{{#2}\overline{\doubleplus}{#1}}
\newcommand*{\deletemap}[2]{{#1}\overline{[{#2}]}}
\newcommand*{\delete}[2]{{#2}{\langle{#1}\rangle}^{-1}}
\newcommand*{\filter}{\mathsf{filter}}
\newcommand*{\Lete}{\mathtt{val}}
\newcommand*{\Letm}{\mathtt{mod}}

\newcommand*{\ValRel}[1]{\mathcal{V}\sembracket{#1}}
\newcommand*{\ExprRel}[1]{\mathcal{E}\sembracket{#1}}
\newcommand*{\CtxRel}[1]{\mathcal{C}\sembracket{#1}}
\newcommand*{\ModRel}[1]{\mathcal{M}\sembracket{#1}}
\newcommand*{\TyEnv}{\text{TyEnv}}
\newcommand*{\TyVar}{\text{TyVar}}
\newcommand*{\Type}{\text{Type}}
\newcommand*{\Subst}{\text{Subst}}
\newcommand*{\external}{\Gamma_{\text{ext}}}

\newcommand*{\event}{E}
\newcommand*{\Event}{\text{Event}}
\newcommand*{\InitE}{\textsf{Init}}
\newcommand*{\ReadE}{\textsf{Read}}
\newcommand*{\CallE}{\textsf{Call}}
\newcommand*{\resolve}{\downarrow_{\ctx_0}}
\newcommand*{\cstr}{c}
\newcommand*{\Cstr}{C}
\newcommand*{\constraints}{\mathbb{C}}
